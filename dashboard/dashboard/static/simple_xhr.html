<!doctype html>
<!--
Copyright 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<script>

var simple_xhr = (function() {

  var LOGIN_ERROR_MESSAGE = 'Please check if you are logged in with a ' +
                            'google.com or chromium.org account in the ' +
                            'upper right corner of the page.';

  var handleError = function(request, callback) {
    callback(LOGIN_ERROR_MESSAGE);
  };

  var handleLoad = function(request, loadCallback, errorCallback) {
    if (request.status != 200) {
      errorCallback('HTTP error ' + request.status);
      return;
    }
    try {
      var response = JSON.parse(request.responseText);
    } catch (e) {
      errorCallback(LOGIN_ERROR_MESSAGE);
      return;
    }
    if (response.error) {
      errorCallback(response.error);
      return;
    }
    loadCallback(response);
  };

  var send = function(url, params, loadCallback, errorCallback) {
    var postdata = '';
    for (var name in params) {
      postdata += '&' + name + '=' + encodeURIComponent(params[name]);
    }
    var request = new XMLHttpRequest();
    request.onerror = handleError.bind(this, request, errorCallback);
    request.onload = handleLoad.bind(
        this, request, loadCallback, errorCallback);
    request.open('post', url, true);
    request.setRequestHeader(
        'Content-type', 'application/x-www-form-urlencoded');
    request.send(postdata);
    return request;
  };

  return {
    send: send
  };
})();

</script>
