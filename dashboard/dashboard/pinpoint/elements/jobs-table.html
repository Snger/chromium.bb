<!DOCTYPE html>
<!--
Copyright 2017 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/components/iron-icon/iron-icon.html">
<link rel="import" href="/components/iron-icons/iron-icons.html">
<link rel="import" href="/components/paper-button/paper-button.html">

<link rel="import" href="/dashboard/static/simple_xhr.html">
<link rel="import" href="/dashboard/static/uri.html">

<dom-module id="jobs-table">
  <template>
    <style>
      .error {
        color: var(--paper-red-500);
        font-weight: bold;
      }

      table {
        width: 100%;
      }

      tr:nth-child(even) {
        background: var(--paper-indigo-50);
      }

      th {
        color: var(--paper-indigo-50);
        background-color: var(--paper-indigo-500);
        background-size: 0.8em;
        background-position: right 0.5em center;
        background-repeat: no-repeat;
        cursor: pointer;
      }

      th, td {
        padding: 0.5em 1em;
      }

      th:not([data-sort-direction]) {
        background-image: url("/dashboard/static/sort-up-down.svg");
      }

      th[data-sort-direction=true] {
        color: white;
        background-image: url("/dashboard/static/sort-up.svg");
      }

      th[data-sort-direction=false] {
        color: white;
        background-image: url("/dashboard/static/sort-down.svg");
      }

      a {
        color: var(--paper-pink-a200);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }
    </style>
    <template is="dom-if" if="{{error}}">
      <p class="error">{{error}}</p>
    </template>
    <table id="jobs">
      <thead>
        <tr>
          <th id="job_id" on-click="columnHeaderClicked">Job ID</th>
          <th id="status" on-click="columnHeaderClicked">Status</th>
          <th id="created" on-click="columnHeaderClicked">Created</th>
          <th id="configuration" on-click="columnHeaderClicked">Configuration</th>
          <th id="benchmark" on-click="columnHeaderClicked">Benchmark</th>
          <th id="story" on-click="columnHeaderClicked">Story</th>
          <th id="metric" on-click="columnHeaderClicked">Metric</th>
        </tr>
      </thead>
      <tbody>
        <template is="dom-repeat" items="{{jobsList}}">
          <tr>
            <td><a href='/job/{{item.job_id}}'>{{item.job_id}}</a></td>
            <td>{{item.status}}</td>
            <td>{{item.created}}</td>
            <td>{{item.arguments.configuration}}</td>
            <td>{{item.arguments.benchmark}}</td>
            <td>{{item.arguments.story}}</td>
            <td>{{item.arguments.metric}}</td>
          </tr>
        </template>
      </tbody>
    </table>
  </template>
  <script>
  'use strict';

  (function() {
    Polymer({

      is: 'jobs-table',
      properties: {
        jobsList: {
          type: Array,
          value: () => []
        },

        xsrfToken: {
          type: String
        },

        /**
         * The field to sort by. Note that this will be both the id of a th
         * element in the table, and a property of an item in the job list.
         */
        sortBy: {
          type: String,
          value: 'created',
          notify: true,
          observer: 'sortByChanged'
        },

        /**
         * Sort direction, either 'down' (increasing) or 'up' (decreasing).
         */
        sortDescending: {
          type: Boolean,
          value: true,
          notify: true,
          observer: 'sortDirectionChanged'
        },
      },

      /**
       * Custom element lifecycle callback, called once this element is ready.
       */
      ready() {
        // You can't actually manipulate the array until after initialization,
        // none of the changes persist.
        this.async(() => this.sort());
      },

      sortByChanged() {
        this.sort();
      },

      sortDirectionChanged() {
        this.sort();
      },

      /**
       * Callback for the click event for a column header.
       * @param {Event} event Clicked event.
       * @param {Object} detail Detail Object.
       */
      columnHeaderClicked(event, detail) {
        if (this.sortBy == event.currentTarget.id) {
          this.sortDescending = !this.sortDescending;
        } else {
          this.sortBy = event.currentTarget.id;
          this.sortDescending = false;
        }
      },

      /**
       * Update the table headers to indicate the current table sorting.
       */
      updateHeaders() {
        const headers = Polymer.dom(this.$.jobs).querySelectorAll('th');
        for (let i = 0; i < headers.length; i++) {
          if (headers[i].id == this.sortBy) {
            Polymer.dom(headers[i]).setAttribute('data-sort-direction',
                this.sortDescending);
          } else {
            Polymer.dom(headers[i]).removeAttribute('data-sort-direction');
          }
        }
      },

      /**
       * Sorts the jobs list according to the current values of the properties
       * sortDirection and sortBy.
       */
      sort() {
        const sortBy = this.sortBy;

        const jobs = this.jobsList.slice();
        jobs.sort(function(a, b) {
          const valA = String(a[sortBy]).toLowerCase();
          const valB = String(b[sortBy]).toLowerCase();
          return valA.localeCompare(valB);
        });
        if (this.sortDescending) {
          jobs.reverse();
        }

        this.set('jobsList', jobs);
        this.updateHeaders();
      }
    });
  })();
  </script>
</dom-module>
