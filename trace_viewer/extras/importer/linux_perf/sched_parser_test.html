<!DOCTYPE html>
<!--
Copyright (c) 2013 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/core/test_utils.html">
<link rel="import" href="/extras/importer/linux_perf/linux_perf_importer.html">

<script>
'use strict';

tv.b.unittest.testSuite(function() { // @suppress longLineCheck
  test('schedSwitchRE', function() {
    var re = tv.e.importer.linux_perf._SchedParserTestExports.schedSwitchRE;
    var x = re.exec('prev_comm=swapper prev_pid=0 prev_prio=120 prev_state=R ' +
        '==> next_comm=SurfaceFlinger next_pid=178 next_prio=112');
    assert.isNotNull(x);
    assert.equal('swapper', x[1]);
    assert.equal('0', x[2]);
    assert.equal('120', x[3]);
    assert.equal('R', x[4]);
    assert.equal('SurfaceFlinger', x[5]);
    assert.equal('178', x[6]);
    assert.equal('112', x[7]);

    var x = re.exec('prev_comm=.android.chrome prev_pid=1562 prev_prio=120 prev_state=R ==> next_comm=Binder Thread # next_pid=195 next_prio=120'); // @suppress longLineCheck
    assert.isNotNull(x);
    assert.equal('.android.chrome', x[1]);
    assert.equal('Binder Thread #', x[5]);

    var x = re.exec('prev_comm=Binder Thread # prev_pid=1562 prev_prio=120 prev_state=R ==> next_comm=.android.chrome next_pid=195 next_prio=120'); // @suppress longLineCheck
    assert.isNotNull(x);
    assert.equal('Binder Thread #', x[1]);
    assert.equal('.android.chrome', x[5]);

    // explicit test for prev_state of D|W
    var x = re.exec('prev_comm=.android.chrome prev_pid=1562 prev_prio=120 ' +
        'prev_state=D|W ==> next_comm=Binder Thread # next_pid=195 ' +
        'next_prio=120');
    assert.isNotNull(x);
    assert.equal('D|W', x[4]);
  });

  test('schedWakeupRE', function() {
    var re = tv.e.importer.linux_perf._SchedParserTestExports.schedWakeupRE;
    var x = re.exec(
        'comm=SensorService pid=207 prio=112 success=1 target_cpu=000');
    assert.isNotNull(x);
    assert.equal('SensorService', x[1]);
    assert.equal('207', x[2]);
    assert.equal('112', x[3]);
    assert.equal('1', x[4]);
    assert.equal('000', x[5]);
  });

  test('importOneSequenceWithSchedWakeUp', function() {
    var lines = [
      'ndroid.launcher-584   [001] d..3 12622.506890: sched_switch: prev_comm=ndroid.launcher prev_pid=584 prev_prio=120 prev_state=R+ ==> next_comm=Binder_1 next_pid=217 next_prio=120', // @suppress longLineCheck
      '       Binder_1-217   [001] d..3 12622.506918: sched_switch: prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=D ==> next_comm=ndroid.launcher next_pid=584 next_prio=120', // @suppress longLineCheck
      'ndroid.launcher-584   [001] d..4 12622.506936: sched_wakeup: comm=Binder_1 pid=217 prio=120 success=1 target_cpu=001', // @suppress longLineCheck
      'ndroid.launcher-584   [001] d..3 12622.506950: sched_switch: prev_comm=ndroid.launcher prev_pid=584 prev_prio=120 prev_state=R+ ==> next_comm=Binder_1 next_pid=217 next_prio=120', // @suppress longLineCheck
      '       Binder_1-217   [001] ...1 12622.507057: tracing_mark_write: B|128|queueBuffer', // @suppress longLineCheck
      '       Binder_1-217   [001] ...1 12622.507175: tracing_mark_write: E',
      '       Binder_1-217   [001] d..3 12622.507253: sched_switch: prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=S ==> next_comm=ndroid.launcher next_pid=584 next_prio=120' // @suppress longLineCheck
    ];

    var m = new tv.c.TraceModel(lines.join('\n'), false);
    assert.isFalse(m.hasImportWarnings);

    var thread = m.findAllThreadsNamed('Binder_1')[0];
    var timeSlices = thread.timeSlices;
    assert.equal(4, timeSlices.length);

    var runningSlice = timeSlices[0];
    assert.equal('Running', runningSlice.title);
    assert.closeTo(12622506.890, runningSlice.start, 1e-5);
    assert.closeTo(.918 - .890, runningSlice.duration, 1e-5);

    var sleepSlice = timeSlices[1];
    assert.equal('Uninterruptible Sleep', sleepSlice.title);
    assert.closeTo(12622506.918, sleepSlice.start, 1e-5);
    assert.closeTo(.936 - .918, sleepSlice.duration, 1e-5);

    var wakeupSlice = timeSlices[2];
    assert.equal('Runnable', wakeupSlice.title);
    assert.closeTo(12622506.936, wakeupSlice.start, 1e-5);
    assert.closeTo(.950 - .936, wakeupSlice.duration, 1e-5);
    assert.equal(584, wakeupSlice.args['wakeup from tid']);

    var runningSlice2 = timeSlices[3];
    assert.equal('Running', runningSlice2.title);
    assert.closeTo(12622506.950, runningSlice2.start, 1e-5);
    assert.closeTo(7.253 - 6.950, runningSlice2.duration, 1e-5);
  });

  test('importWithUnknownSleepState', function() {
    var lines = [
      'ndroid.launcher-584   [001] d..3 12622.506890: sched_switch: prev_comm=ndroid.launcher prev_pid=584 prev_prio=120 prev_state=R+ ==> next_comm=Binder_1 next_pid=217 next_prio=120', // @suppress longLineCheck
      '       Binder_1-217   [001] d..3 12622.506918: sched_switch: prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=F|O ==> next_comm=ndroid.launcher next_pid=584 next_prio=120', // @suppress longLineCheck
      'ndroid.launcher-584   [001] d..4 12622.506936: sched_wakeup: comm=Binder_1 pid=217 prio=120 success=1 target_cpu=001', // @suppress longLineCheck
      'ndroid.launcher-584   [001] d..3 12622.506950: sched_switch: prev_comm=ndroid.launcher prev_pid=584 prev_prio=120 prev_state=R+ ==> next_comm=Binder_1 next_pid=217 next_prio=120', // @suppress longLineCheck
      '       Binder_1-217   [001] ...1 12622.507057: tracing_mark_write: B|128|queueBuffer', // @suppress longLineCheck
      '       Binder_1-217   [001] ...1 12622.507175: tracing_mark_write: E',
      '       Binder_1-217   [001] d..3 12622.507253: sched_switch: prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=F|O ==> next_comm=ndroid.launcher next_pid=584 next_prio=120' // @suppress longLineCheck
    ];

    var m;
    assert.doesNotThrow(function() {
      m = new tv.c.TraceModel(lines.join('\n'), false);
    });
    assert.isTrue(m.hasImportWarnings);
    assert.equal('Unrecognized sleep state: F|O', m.importWarnings[0].message);

    var thread = m.findAllThreadsNamed('Binder_1')[0];
    var timeSlices = thread.timeSlices;

    assert.equal('UNKNOWN', timeSlices[1].title);
  });

  test('importWithUninterruptibleSleep', function() {
    var lines = [
      'ndroid.launcher-584   [001] d..3 12622.506890: sched_switch: ' +
          'prev_comm=ndroid.launcher prev_pid=584 ' +
          'prev_prio=120 prev_state=R+ ' +
          '==> next_comm=Binder_1 next_pid=217 next_prio=120',

      '       Binder_1-217   [001] d..3 12622.506918: sched_switch: ' +
          'prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=D|K ' +
          '==> next_comm=ndroid.launcher next_pid=584 next_prio=120',

      'ndroid.launcher-584   [001] d..4 12622.506936: sched_wakeup: ' +
          'comm=Binder_1 pid=217 prio=120 success=1 target_cpu=001',

      'ndroid.launcher-584   [001] d..3 12622.506950: sched_switch: ' +
          'prev_comm=ndroid.launcher prev_pid=584 ' +
          'prev_prio=120 prev_state=R+ ' +
          '==> next_comm=Binder_1 next_pid=217 next_prio=120',

      '       Binder_1-217   [001] ...1 12622.507057: tracing_mark_write: ' +
          'B|128|queueBuffer',

      '       Binder_1-217   [001] ...1 12622.507175: tracing_mark_write: E',

      '       Binder_1-217   [001] d..3 12622.507253: sched_switch: ' +
          'prev_comm=Binder_1 prev_pid=217 prev_prio=120 prev_state=S ' +
          '==> next_comm=ndroid.launcher next_pid=584 next_prio=120'
    ];

    var m = new tv.c.TraceModel(lines.join('\n'), false);
    assert.isFalse(m.hasImportWarnings);

    var thread = m.findAllThreadsNamed('Binder_1')[0];
    var timeSlices = thread.timeSlices;
    assert.equal(4, timeSlices.length);

    var wakeKillSlice = timeSlices[1];
    assert.equal('Uninterruptible Sleep | WakeKill', wakeKillSlice.title);
    assert.closeTo(12622506.918, wakeKillSlice.start, 1e-5);
    assert.closeTo(.936 - .918, wakeKillSlice.duration, 1e-5);
  });
});
</script>

