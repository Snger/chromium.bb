<!DOCTYPE html>
<!--
Copyright (c) 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/base/polymer_utils.html">
<link rel="import" href="/core/analysis/tab_view.html">
<link rel="import" href="/core/analysis/analysis_sub_view.html">

<!-- Sub Views. -->
<link rel="import" href="/core/analysis/single_slice_sub_view.html">
<link rel="import" href="/core/analysis/multi_slice_sub_view.html">

<link rel="import" href="/core/analysis/single_thread_time_slice_sub_view.html">
<link rel="import" href="/core/analysis/single_cpu_slice_sub_view.html">

<link rel="import" href="/core/analysis/single_instant_event_sub_view.html">
<link rel="import" href="/core/analysis/multi_instant_event_sub_view.html">

<link rel="import" href="/core/analysis/counter_sample_sub_view.html">

<link rel="import" href="/core/analysis/single_flow_event_sub_view.html">
<link rel="import" href="/core/analysis/multi_flow_event_sub_view.html">

<link rel="import" href="/core/analysis/single_object_instance_sub_view.html">
<link rel="import" href="/core/analysis/single_object_snapshot_sub_view.html">
<link rel="import" href="/core/analysis/multi_object_sub_view.html">

<link rel="import" href="/core/analysis/single_sample_sub_view.html">
<link rel="import" href="/core/analysis/multi_sample_sub_view.html">

<!--
@fileoverview A component used to display an analysis of a selection,
using custom elements specialized for different event types.
-->
<polymer-element name="tracing-analysis-view"
    constructor="TracingAnalysisView">
  <template>
    <style>
      :host {
        background-color: white;
        display: flex;
        flex-direction: column;
        height: 275px;
        overflow: auto;
      }

      :host(.tall-mode) {
        height: 525px;
      }

      ::content > * {
        flex: 1 0 auto;
      }
    </style>
    <content></content>
  </template>
  <script>
  'use strict';
  (function() {
    /**
     * Utility function used to convert camelCase to Title Case.
     */
    function convertCamelCaseToTitleCase(name) {
      var result = name.replace(/[A-Z]/g, ' $&');
      result = result.charAt(0).toUpperCase() + result.slice(1);
      return result;
    }

    Polymer({
      ready: function() {
        this.tabView_ = undefined;
        this.currentSelection_ = undefined;
      },

      set tallMode(value) {
        if (value)
          this.classList.add('tall-mode');
        else
          this.classList.remove('tall-mode');
      },

      get tallMode() {
        return this.classList.contains('tall-mode');
      },

      get tabView() {
        return this.tabView_;
      },

      get selection() {
        return this.currentSelection_;
      },

      set selection(selection) {
        this.processSelection_(selection);
      },

      processSelection_: function(selection) {
        this.tallMode = false;
        this.textContent = '';

        var eventsByBaseTypeName = selection.getEventsOrganizedByBaseType(true);

        var numBaseTypesToAnalyze = tv.b.dictionaryLength(eventsByBaseTypeName);

        // If we have to analyze more than one category, we use a tab view
        // for displaying them.
        var tabView = new TracingAnalysisTabView();
        this.appendChild(tabView);

        for (var eventTypeName in eventsByBaseTypeName) {
          var subSelection = eventsByBaseTypeName[eventTypeName];
          var subView = this.createSubViewForSelection_(
            eventTypeName, subSelection);
          tabView.appendChild(subView);

          subView.selection = subSelection;

          this.tallMode = this.tallMode || subView.requiresTallView;
        }

        tabView.selectedTab = tabView.firstChild;
        this.tabView_ = tabView
      },

      createSubViewForSelection_: function(eventTypeName, subSelection) {
        // Find.
        var eventTypeInfo = tv.c.ALL_EVENT_TYPES_BY_NAME[eventTypeName];
        var singleMode = subSelection.length == 1;
        var tagName;
        if (subSelection.length === 1)
          tagName = tv.c.ALL_EVENT_TYPES_BY_NAME[eventTypeName].singleViewElementName;
        else
          tagName = tv.c.ALL_EVENT_TYPES_BY_NAME[eventTypeName].multiViewElementName;

        if (!tv.b.getPolymerElementNamed(tagName))
          throw new Error('Element not registered: ' + tagName);

        // Create.
        var subView = document.createElement(tagName);

        // Set label.
        var camelLabel;
        if (subSelection.length === 1)
          camelLabel = eventTypeInfo.name;
        else
          camelLabel = eventTypeInfo.pluralName;

        subView.tabLabel = convertCamelCaseToTitleCase(camelLabel);

        return subView;
      }
    });
  })();
  </script>
</polymer-element>
