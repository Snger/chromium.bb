<!DOCTYPE html>
<!--
Copyright (c) 2013 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/base/base.html">
<link rel="import" href="/base/iteration_helpers.html">
<link rel="import" href="/base/statistics.html">
<link rel="import" href="/core/analysis/table_builder.html">
<link rel="import" href="/core/analysis/time_span.html">

<script>
'use strict';
tv.exportTo('tv.c.analysis', function() {
  function createTimeSpan(duration) {
    if (duration === undefined)
      return '';
    var span = document.createElement('tv-c-a-time-span');
    span.duration = duration;
    return span;
  }

  function SummaryRow(title, events) {
    this.title = title;
    this.duration_ = undefined;
    this.selfTime_ = undefined;
    this.events_ = events;

    this.cpuTimesComputed_ = false;
    this.cpuSelfTime_ = undefined;
    this.cpuDuration_ = undefined;
  };
  SummaryRow.prototype = {
    get duration() {
      if (this.duration_ === undefined) {
        this.duration_ = tv.b.Statistics.sum(
            this.events_, function(event) {
                return event.duration;
            });
      }
      return this.duration_;
    },

    get cpuSelfTime() {
      this.computeCpuTimesIfNeeded_();
      return this.cpuSelfTime_;
    },

    get cpuDuration() {
      this.computeCpuTimesIfNeeded_();
      return this.cpuDuration_;
    },

    computeCpuTimesIfNeeded_: function() {
      if (this.cpuTimesComputed_)
        return;
      this.cpuTimesComputed_ = true;

      var cpuSelfTime = 0;
      var cpuDuration = 0;
      var hasCpuData = false;
      for (var i = 0; i < this.events_.length; i++) {
        var event = this.events_[i];
        if (event.cpuDuration !== undefined) {
          cpuDuration += event.cpuDuration;
          hasCpuData = true;
        }

        if (event.cpuSelfTime !== undefined) {
          cpuSelfTime += event.cpuSelfTime;
          hasCpuData = true;
        }
      }
      if (hasCpuData) {
        this.cpuDuration_ = cpuDuration;
        this.cpuSelfTime_ = cpuSelfTime;
      }
    },

    get selfTime() {
      if (this.selfTime_ === undefined) {
        this.selfTime_ = tv.b.Statistics.sum(
            this.events_, function(event) {
                return event.selfTime;
            });
      }
      return this.selfTime_;
    },

    get events() {
      return this.events_;
    },

    get numEvents() {
      return this.events_.length;
    }
  };

  return {
    SummaryRow: SummaryRow,
    createTimeSpan: createTimeSpan
  };
});

</script>
<polymer-element name='tv-c-a-multi-event-summary-table'>
  <template>
    <style>
    :host {
      display: flex;
    }
    #table {
      flex: 1 1 auto;
      align-self: stretch;
    }
    </style>
    <tracing-analysis-nested-table id="table">
    </tracing-analysis-nested-table>
    </div>
  </template>
  <script>
  'use strict';

  Polymer({
    ready: function() {
      this.showTotals_ = false;
      this.eventsByTitle_ = undefined;
      this.selectionBounds_ = new tv.b.Range();
    },

    updateTableColumns_: function(rows) {
      var hasCpuData = false;
      rows.forEach(function(row) {
        if (row.cpuDuration !== undefined)
          hasCpuData = true;
        if (row.cpuSelfTime !== undefined)
          hasCpuData = true;
      });

      var colWidthPercentage;
      if (hasCpuData)
        colWidthPercentage = '20%';
      else
        colWidthPercentage = '33.3333%';

      var columns = [];

      columns.push({
        title: 'Name',
        value: function(row) { return row.title; },
        width: '350px',
        cmp: function(rowA, rowB) {
          return rowA.title.localeCompare(rowB.title);
        }
      });
      columns.push({
        title: 'Wall Duration (ms)',
        value: function(row) {
          return tv.c.analysis.createTimeSpan(row.duration);
        },
        width: colWidthPercentage,
        cmp: function(rowA, rowB) {
          return rowA.duration - rowB.duration;
        }
      });

      if (hasCpuData) {
        columns.push({
          title: 'CPU Duration (ms)',
          value: function(row) {
            return tv.c.analysis.createTimeSpan(row.cpuDuration);
          },
          width: colWidthPercentage,
          cmp: function(rowA, rowB) {
            return rowA.cpuDuration - rowB.cpuDuration;
          }
        });
      }

      columns.push({
        title: 'Self time (ms)',
        value: function(row) {
          return tv.c.analysis.createTimeSpan(row.selfTime);
        },
        width: colWidthPercentage,
        cmp: function(rowA, rowB) {
          return rowA.selfTime - rowB.selfTime;
        }
      });
      if (hasCpuData) {
        columns.push({
          title: 'CPU Self Time (ms)',
          value: function(row) {
            return tv.c.analysis.createTimeSpan(row.cpuSelfTime);
          },
          width: colWidthPercentage,
          cmp: function(rowA, rowB) {
            return rowA.cpuSelfTime - rowB.cpuSelfTime;
          }
        });
      }
      columns.push({
        title: 'Occurrences',
        value: function(row) {
          return row.numEvents;
        },
        width: colWidthPercentage,
        cmp: function(rowA, rowB) {
          return rowA.numEvents - rowB.numEvents;
        }
      });

      this.$.table.tableColumns = columns;
    },

    configure: function(config) {
      this.showTotals_ = config.showTotals;
      this.eventsByTitle_ = config.eventsByTitle;
      this.selectionBounds_ = config.selectionBounds;
      this.updateContents_();
    },

    get showTotals() {
      return this.showTotals_;
    },

    set showTotals(showTotals) {
      this.showTotals_ = showTotals;
      this.updateContents_();
    },

    get eventsByTitle() {
      return this.eventsByTitle_;
    },

    set eventsByTitle(eventsByTitle) {
      this.eventsByTitle_ = eventsByTitle;
      this.appendChild(this.updateContents_());
    },

    get selectionBounds() {
      return this.selectionBounds_;
    },

    set selectionBounds(selectionBounds) {
      this.selectionBounds_ = selectionBounds;
      this.updateContents_();
    },

    updateContents_: function() {
      var eventsByTitle;
      if (this.eventsByTitle_ !== undefined)
        eventsByTitle = this.eventsByTitle_;
      else
        eventsByTitle = [];

      var allEvents = [];
      var rows = [];
      tv.b.iterItems(
          eventsByTitle,
          function(title, eventsOfSingleTitle) {
            allEvents.push.apply(allEvents, eventsOfSingleTitle);
            var row = new tv.c.analysis.SummaryRow(title, eventsOfSingleTitle);
            rows.push(row);
          });

      this.updateTableColumns_(rows);
      this.$.table.tableRows = rows;

      var footerRows = [];

      if (this.showTotals_)
        footerRows.push(new tv.c.analysis.SummaryRow('Totals', allEvents));

      // TODO(selection bounds).

      // TODO(sorting)

      this.$.table.footerRows = footerRows;
      this.$.table.rebuild();
    }
  });
  </script>
</polymer>
