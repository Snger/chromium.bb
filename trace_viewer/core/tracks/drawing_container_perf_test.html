<!DOCTYPE html>
<!--
Copyright (c) 2013 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/base/xhr.html">
<link rel="import" href="/core/trace_model/trace_model.html">
<link rel="import" href="/extras/full_config.html">

<script>
'use strict';

tv.b.unittest.testSuite(function() {  // @suppress longLineCheck
  var generalModel;
  function getOrCreateGeneralModel() {
    if (generalModel !== undefined)
      generalModel;
    var fileUrl = '/test_data/thread_time_visualisation.json.gz';
    var events = tv.b.getSync(fileUrl);
    generalModel = new tv.c.TraceModel();
    generalModel.importTraces([events], true);
    return generalModel;
  }

  function DCPerfTestCase(testName, opt_options) {
    tv.b.unittest.PerfTestCase.call(this, testName, undefined, opt_options);
    this.viewportDiv = undefined;
    this.drawingContainer = undefined;
  }
  DCPerfTestCase.prototype = {
    __proto__: tv.b.unittest.PerfTestCase.prototype,

    setUp: function(model) {
      this.viewportDiv = document.createElement('div');

      var viewport = new tv.c.TimelineViewport(this.viewportDiv);

      this.drawingContainer = new tv.c.tracks.DrawingContainer(viewport);
      viewport.modelTrackContainer = this.drawingContainer;

      var modelTrack = new tv.c.tracks.TraceModelTrack(viewport);
      this.drawingContainer.appendChild(modelTrack);

      modelTrack.model = model;

      this.viewportDiv.appendChild(this.drawingContainer);

      this.addHTMLOutput(this.viewportDiv);

      // Size the canvas.
      this.drawingContainer.updateCanvasSizeIfNeeded_();

      // Size the viewport.
      var w = this.drawingContainer.canvas.width;
      var min = model.bounds.min;
      var range = model.bounds.range;

      var boost = range * 0.15;
      var dt = new tv.c.TimelineDisplayTransform();
      dt.xSetWorldBounds(min - boost, min + range + boost, w);
      modelTrack.viewport.setDisplayTransformImmediately(dt);
    },

    runOneIteration: function() {
      this.drawingContainer.draw_();
    },

    tearDown: function() {
      this.viewportDiv.innerText = '';
      this.drawingContainer = undefined;
    }
  };


  function GeneralDCPerfTestCase(testName, opt_options) {
    DCPerfTestCase.call(this, testName, opt_options);
  }

  GeneralDCPerfTestCase.prototype = {
    __proto__: DCPerfTestCase.prototype,

    setUp: function() {
      var model = getOrCreateGeneralModel();
      DCPerfTestCase.prototype.setUp.call(this, model);
    }
  };

  test(new GeneralDCPerfTestCase('draw_softwareCanvas_One',
                                 {iterations: 1}));
  test(new GeneralDCPerfTestCase('draw_softwareCanvas_Ten',
                                 {iterations: 10}));
  test(new GeneralDCPerfTestCase('draw_softwareCanvas_AHundred',
                                 {iterations: 100}));
});
</script>

