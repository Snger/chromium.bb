<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/base/extension_registry.html">

<script>
'use strict';

/**
 * @fileoverview Provides the Attribute class.
 */
tv.exportTo('tv.c.trace_model', function() {

  /**
   * @constructor
   */
  function Attribute() {
  }

  Attribute.fromDictIfPossible = function(args, opt_model) {
    var typeInfo = Attribute.findTypeInfoMatching(function(typeInfo) {
      return typeInfo.metadata.type === args.type;
    });

    var value = args.value;

    if (typeInfo === undefined) {
      if (opt_model) {
        opt_model.importWarning({
            type: 'attribute_parse_error',
            message: 'Unknown attribute type \'' + args.type + '\'' +
                ' (value=' + attribute.value + ').'
        });
      }
      return UnknownAttribute.fromTraceValue(value, opt_model);
    }

    return typeInfo.constructor.fromTraceValue(value, opt_model);
  };

  Attribute.fromTraceValue = function(value, opt_model) {
    throw new Error('Not implemented');
  };

  var options = new tv.b.ExtensionRegistryOptions(tv.b.BASIC_REGISTRY_MODE);
  options.mandatoryBaseType = Attribute;
  tv.b.decorateExtensionRegistry(Attribute, options);

  Attribute.addEventListener('will-register', function(e) {
    if (!e.typeInfo.constructor.hasOwnProperty('fromTraceValue'))
      throw new Error('Must have fromTraceValue method');

    if (!e.typeInfo.metadata.type)
      throw new Error('Registered Attributes must provide type');
  });

  /**
   * @constructor
   */
  function ScalarAttribute(value) {
    this.value = value;
  }

  ScalarAttribute.fromTraceValue = function(traceValue) {
    return new ScalarAttribute(parseInt(traceValue, 16));
  };

  ScalarAttribute.prototype = {
    __proto__: Attribute.prototype
  };

  Attribute.register(ScalarAttribute, {type: 'scalar'});

  /**
   * @constructor
   */
  function BytesAttribute(value) {
    this.value = value;
  }

  BytesAttribute.fromTraceValue = function(traceValue) {
    return new BytesAttribute(parseInt(traceValue, 16));
  };

  BytesAttribute.prototype = {
    __proto__: Attribute.prototype
  };

  Attribute.register(BytesAttribute, {type: 'bytes'});

  /**
   * @constructor
   */
  function UnknownAttribute(value) {
    this.value = value;
  }

  UnknownAttribute.fromTraceValue = function(traceValue) {
    return new UnknownAttribute(traceValue);
  };

  UnknownAttribute.prototype = {
    __proto__: Attribute.prototype
  };

  return {
    Attribute: Attribute,
    ScalarAttribute: ScalarAttribute,
    BytesAttribute: BytesAttribute,
    UnknownAttribute: UnknownAttribute
  };
});
</script>
