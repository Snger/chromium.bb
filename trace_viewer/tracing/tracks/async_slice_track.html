<!DOCTYPE html>
<!--
Copyright (c) 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/tracks/rect_track.html">

<script>
'use strict';

tv.exportTo('tracing.tracks', function() {
  /**
   * A track that displays an array of Async Slice objects.
   * @constructor
   * @extends {RectTrack}
   */
  var AsyncSliceTrack = tv.ui.define(
      'async-slice-track', tracing.tracks.RectTrack);

  AsyncSliceTrack.prototype = {

    __proto__: tracing.tracks.RectTrack.prototype,

    decorate: function(viewport) {
      tracing.tracks.RectTrack.prototype.decorate.call(this, viewport);
    },

    get slices() {
      return this.rects;
    },

    set slices(slices) {
      // A helper function that returns the appropriate title for a slice.
      var getTitle = function(aSlice) {
        if (aSlice.isTopLevel !== undefined && aSlice.isTopLevel === true) {
          var url = getUrl(aSlice);
          if (url !== undefined && url.length > 0)
            return url;
        }
        return aSlice.title;
      };

      // A recursive helper function that gets the url param of a slice or its
      // nested subslices if there is one.
      var getUrl = function(aSlice) {
        if (aSlice.args !== undefined) {
          if (aSlice.args.params !== undefined) {
            if (aSlice.args.params.url !== undefined)
              return aSlice.args.params.url;
          }
        }
        if (aSlice.subSlices === undefined || aSlice.subSlices.length === 0)
          return undefined;
        for (var i = 0; i < aSlice.subSlices.length; i++) {
          var result = getUrl(aSlice.subSlices[i]);
          if (result !== undefined)
            return result;
        }
        return undefined;
      };

      this.rects = slices.map(function(slice) {
        return {
          title: getTitle(slice),
          start: slice.start,
          duration: slice.duration,
          colorId: slice.colorId,
          guid: slice.guid,
          args: slice.args,
          category: slice.category,
          error: slice.error,
          __proto__: slice.__proto__
        }
      });
    },

    addRectToSelection: function(slice, selection) {
      selection.push(slice);
    }
  };

  return {
    AsyncSliceTrack: AsyncSliceTrack
  };
});
</script>

