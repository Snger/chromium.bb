<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2010 Google Inc.  All rights reserved. -->
  <head>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
  <title>PPAPI GetURL Test</title>
  </head>
  <body>
    <h1>PPAPI GetURL Test</h1>

    <embed type="application/x-nacl" id="nacl" name="nacl_module"
           nacl="ppapi_geturl.nmf" width="0" height="0" />

    <script type="text/javascript" src="nacltest.js"></script>
    <script type="text/javascript">
      //<![CDATA[
      var VALID_URL = 'ppapi_geturl_success.html';
      var CROSSORIGIN_URL = 'http://www.google.com/robots.txt';
      var INVALID_URL = 'ppapi_nonexistent_url.html';

      function isMatch(actual, expected) {
        return (0 <= actual.indexOf(expected));
      }

      function setupTests(tester, plugin) {
        // TODO(ncbray) replace with an asynchronous test framework
        function makeTest(name, url, as_file, expected_data, expected_success) {
          tester.addTest(name, function() {
            // Variables to hold the response.
            var responded = false;
            var response_url = undefined;
            var response_as_file = undefined;
            var response_data = undefined;
            var response_success = undefined;

            // Intentionally sets a global variable
            // This prevents running the tests in parallel...
            ReportResult = function(url, as_file, data, success) {
              response_url = url;
              response_as_file = as_file;
              response_data = data;
              response_success = success;
              responded = true;
            }

            // Make the request.
            plugin.loadUrl(url, as_file);

            function wait() {
              if (!responded) {
                // Periodically poll until the results are ready.
                halt_and_callback(5, wait);
              } else {
                // Validate the results.
                assert(isMatch(response_url, url));
                assertEqual(response_as_file, as_file);
                tester.log(response_data);
                assert(isMatch(response_data, expected_data));
                assertEqual(response_success, expected_success);
              }
            }
            wait();
          });
        }

        makeTest('Valid', VALID_URL, false, 'TEST PASSED', true);
        makeTest('Valid_File', VALID_URL, true, 'TEST PASSED', true);
        makeTest('CrossOrigin', CROSSORIGIN_URL, false, 'PP_ERROR_NOACCESS',
                 false);
        makeTest('CrossOrigin_File', CROSSORIGIN_URL, true, 'PP_ERROR_NOACCESS',
                 false);
        makeTest('Invalid', INVALID_URL, false, '404', false);
        makeTest('Invalid_File', INVALID_URL, true, '404', false);
      }

      // TODO(ncbray) allow the test to run in parallel
      var tester = new Tester();
      setupTests(tester, $('nacl'));
      tester.waitFor($('nacl'));
      tester.run();
      //]]>
    </script>
  </body>
</html>
