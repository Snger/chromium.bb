<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2009 Google Inc.  All rights reserved. -->
  <head>
    <title> SRPC Shared Memory API Test </title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[
// All shared memory regions will have this size.
var shm_size = 65536;
// Handle to a shared memory object returned by a NaCl module
var nacl_shm_handle;
function getNaClShmHandle(server) {
  if (nacl_shm_handle == undefined) {
    nacl_shm_handle = server.get_shm_handle(shm_size);
  }
  return nacl_shm_handle;
}
// Shared memory object resulting from mapping a handle from a NaCl module.
var nacl_shm;
function getNaClShm(server) {
  if (nacl_shm == undefined) {
    nacl_shm = getNaClShmHandle(server).map();
  }
  return nacl_shm;
}
// A mapped shared memory object created by the __shmFactory method.
var factory_shm;
function getFactoryShm(server) {
  if (factory_shm == undefined) {
    factory_shm = server.__shmFactory(shm_size);
  }
  return factory_shm;
}
// The epitome of a test string.
var test_str = 'Hello, world.';
// The test string's length.
var str_len = test_str.length;

function factoryTests(tester, server) {
  tester.addTest('factory_with_too_few_arguments', function() {
      assertRaises(function() { return server.__shmFactory(); });
  });
  tester.addTest('factory_with_too_many_arguments', function() {
    assertRaises(function() { return server.__shmFactory(shm_size, 'extra'); });
  });
  tester.addTest('factory_size_null', function() {
    assertRaises(function() { return server.__shmFactory(undefined); });
  });
  tester.addTest('factory_size_string', function() {
    assertRaises(function() { return server.__shmFactory('string'); });
  });
  tester.addTest('factory_size_object', function() {
    assertRaises(function() { return server.__shmFactory(new Array(10)); });
  });
  tester.addTest('factory_size_negative', function() {
    assertRaises(function() { return server.__shmFactory(-1); });
  });
  tester.addTest('factory_valid_call', function() {
    var shm = server.__shmFactory(shm_size);
    assert(typeof(shm), 'object');
  });
}

var mapTests = function(tester, server) {
  tester.addTest('map_get_invalid_handle', function() {
    var shm = server.get_invalid_handle();
    assert(typeof(shm), 'object');
  });
  tester.addTest('map_with_too_many_arguments', function() {
    assertRaises(function() { getNaClShmHandle(server).map(1); });
  });
  tester.addTest('map_valid', function() {
    var mapped = getNaClShmHandle(server).map();
    assert(typeof(mapped), 'object');
  });
  tester.addTest('map_offset_negative', function() {
    assertRaises(function() {
        getNaClShm(server).write(-1, str_len, test_str); });
  });
  tester.addTest('map_offset_beyond_end', function() {
    assertRaises(function() {
        getNaClShm(server).write(shm_size, str_len, test_str); });
  });
  tester.addTest('map_length_negative', function() {
    assertRaises(function() { getNaClShm(server).write(0, -1, test_str); });
  });
  tester.addTest('map_length_beyond_end', function() {
    assertRaises(function() {
        getNaClShm(server).write(0, str_len + 1, test_str); });
  });
  tester.addTest('map_valid_call', function() {
    var written = getNaClShm(server).write(0, str_len, test_str);
    assertEqual(written, undefined);
  });
}

function writeTests(tester, server) {
  tester.addTest('write_with_too_few_arguments', function() {
    assertRaises(function() { getFactoryShm(server).write(0, str_len); });
  });
  tester.addTest('write_with_too_many_arguments', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, str_len, test_str, 'extra'); });
  });
  tester.addTest('write_offset_null', function() {
    assertRaises(function() {
        getFactoryShm(server).write(undefined, str_len, test_str); });
  });
  tester.addTest('write_offset_string', function() {
    assertRaises(function() {
        getFactoryShm(server).write('string', str_len, test_str); });
  });
  tester.addTest('write_offset_object', function() {
    assertRaises(function() {
        getFactoryShm(server).write(new Array(10), str_len, test_str); });
  });
  tester.addTest('write_offset_negative', function() {
    assertRaises(function() {
        getFactoryShm(server).write(-1, str_len, test_str); });
  });
  tester.addTest('write_offset_beyond_end', function() {
    assertRaises(function() {
        getFactoryShm(server).write(shm_size + 1, str_len, test_str); });
  });
  tester.addTest('write_length_null', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, undefined, test_str); });
  });
  tester.addTest('write_length_string', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, 'string', test_str); });
  });
  tester.addTest('write_length_object', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, new Array(10), test_str); });
  });
  tester.addTest('write_length_negative', function() {
    assertRaises(function() { getFactoryShm(server).write(0, -1, test_str); });
  });
  tester.addTest('write_length_beyond_end', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, shm_size + 1, test_str); });
  });
  tester.addTest('write_string_null', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, str_len, undefined); });
  });
  tester.addTest('write_string_integer', function() {
    assertRaises(function() { getFactoryShm(server).write(0, str_len, 10); });
  });
  tester.addTest('write_string_object', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, str_len, new Array(10)); });
  });
  tester.addTest('write_overlaps_region_end', function() {
    assertRaises(function() {
      getFactoryShm(server).write(shm_size - str_len + 1, str_len, test_str);
    });
  });
  tester.addTest('write_length_and_string_length_mismatch', function() {
    assertRaises(function() {
        getFactoryShm(server).write(0, str_len + 1, test_str); });
  });
  tester.addTest('write_valid_call', function() {
    var written = getFactoryShm(server).write(0, str_len, test_str);
    assertEqual(written, undefined);
  });
}

function readTests(tester, server) {
  tester.addTest('read_with_too_few_arguments', function() {
    assertRaises(function() { return getFactoryShm(server).read(0); });
  });
  tester.addTest('read_with_too_many_arguments', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(0, str_len, 'extra'); });
  });
  tester.addTest('read_offset_null', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(undefined, str_len); });
  });
  tester.addTest('read_offset_string', function() {
    assertRaises(function() {
        return getFactoryShm(server).read('string', str_len); });
  });
  tester.addTest('read_offset_object', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(new Array(10), str_len); });
  });
  tester.addTest('read_offset_negative', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(-1, str_len); });
  });
  tester.addTest('read_offset_beyond_end', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(shm_size + 1, str_len); });
  });
  tester.addTest('read_length_null', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(0, undefined); });
  });
  tester.addTest('read_length_string', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(0, 'string'); });
  });
  tester.addTest('read_length_object', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(0, new Array(10)); });
  });
  tester.addTest('read_length_negative', function() {
    assertRaises(function() { return getFactoryShm(server).read(0, -1); });
  });
  tester.addTest('read_length_beyond_end', function() {
    assertRaises(function() {
        return getFactoryShm(server).read(0, shm_size + 1); });
  });
  tester.addTest('read_overlaps_region_end', function() {
    assertRaises(function() {
      return getFactoryShm(server).read(shm_size - str_len + 1, str_len); });
  });
  tester.addTest('read_valid_call', function() {
    var written = getFactoryShm(server).write(0, str_len, test_str);
    var read = getFactoryShm(server).read(0, str_len);
    assertEqual(read, test_str);
  });
}

function enqueueTests(tester, server) {
  factoryTests(tester, server);
  mapTests(tester, server);
  writeTests(tester, server);
  readTests(tester, server);
}
      //]]>
    </script>
  </head>
  <body>
    <h1> SRPC Shared Memory API Test </h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.
    <embed type="application/x-nacl" id="nacl_server" name="nacl_module"
            width="0" height="0" nacl="srpc_shm.nmf" />

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      var server = $("nacl_server");
      enqueueTests(tester, server);
      tester.waitFor(server);
      tester.run();
      //]]>
    </script>
  </body>
</html>
