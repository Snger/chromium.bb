<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2008 Google Inc.  All rights reserved. -->
  <head>
    <title> SRPC Descriptor Passing Test </title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[
var shm_region_size = 65536;
var result_compare_string = 'Quod erat demonstrandum';

function enqueueTests(tester, server, client) {
  tester.addTest('socket_address_nacl_to_nacl', function() {
    var socket_address = server.start_server();
    var client_errors = client.sock_addr_client(socket_address);
    assertEqual(client_errors, 0);
    var server_errors = server.report();
    assertEqual(server_errors, 0);
  });
  tester.addTest('socket_address_nacl_to_browser', function() {
    var socket_address2 = server.start_server();
    var con_sock = socket_address2.connect();
    var retval = con_sock.getmsg(100);
    var str = '';
    for (var i = 0; i < retval.length && retval[i] != 0; i++) {
      str += String.fromCharCode(retval[i]);
    }
    var server_errors = server.report();
    assertEqual(server_errors, 0);
  });
  tester.addTest('shared_memory_browser_to_browser', function() {
    var in_str = 'hello, world';
    var test_offset = 7;
    var shared_memory = server.__shmFactory(65536);
    shared_memory.write(0, in_str.length, in_str);
    var rval = shared_memory.read(test_offset, in_str.length - test_offset);
    assertEqual(rval, in_str.substring(test_offset));
  });
  tester.addTest('shared_memory_browser_to_nacl', function() {
    var in_str = 'hello, world';
    var shared_memory = server.__shmFactory(shm_region_size);
    shared_memory.write(0, in_str.length, in_str);
    var server_errors = server.test_shared_memory(shared_memory, in_str);
    var rval = shared_memory.read(in_str.length, result_compare_string.length);
    assertEqual(server_errors, 0);
    assertEqual(rval, result_compare_string);
  });
  tester.addTest('shared_memory_nacl_to_browser', function() {
    var retval = client.shared_memory_client(shm_region_size);
    var handle = retval[0];
    var in_str = retval[1];
    var client_errors = retval[2];
    var shared_memory = handle.map();
    var read_string = shared_memory.read(0, in_str.length);
    assertEqual(client_errors, 0);
    assertEqual(in_str, read_string);
  });
  tester.addTest('shared_memory_nacl_to_nacl', function() {
    var retval = client.shared_memory_client(shm_region_size);
    var handle = retval[0];
    var in_str = retval[1];
    var client_errors = retval[2];
    assertEqual(client_errors, 0);
    var shared_memory = handle.map();
    var server_errors = server.test_shared_memory(shared_memory, in_str);
    assertEqual(server_errors, 0);
    var rval = shared_memory.read(in_str.length, result_compare_string.length);
    assertEqual(rval, result_compare_string);
  });
}
      //]]>
    </script>
  </head>
  <body>
    <h1> SRPC Descriptor Passing Test </h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.
    <embed type="application/x-nacl" id="nacl_client"
           name="naclModule" width="0" height="0"
           nacl="srpc_nrd_client.nmf" />
    <embed type="application/x-nacl" id="nacl_server"
           name="naclModule" width="0" height="0"
           nacl="srpc_nrd_server.nmf" />

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      var server = $("nacl_server");
      var client = $("nacl_client");
      enqueueTests(tester, server, client);
      tester.waitFor(server, client);
      tester.run();
      //]]>
    </script>
  </body>
</html>
