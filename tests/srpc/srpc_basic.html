<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2009 Google Inc.  All rights reserved. -->
  <head>
    <title> SRPC Parameter Passing Test </title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[

// Tests passing scalar types.
function ScalarTypes(tester, server) {
  tester.addTest('bool_passret', function() {
    assert(!server.bool(true));
    assert(server.bool(false));
  });

  tester.addTest('int_as_bool', function() {
    assertRaises(function() { server.bool(1); });
  });

  tester.addTest('array_as_bool', function() {
    assertRaises(function() { server.bool(new Array(10)); });
  });

  tester.addTest('double_passret', function() {
    var dval = 3.1415;
    assertEqual(server.double(dval), -dval);
  });

  tester.addTest('bool_as_double', function() {
    assertRaises(function() { server.double(true); });
    assertRaises(function() { server.double(false); });
  });

  tester.addTest('int_as_double', function() {
    assertEqual(server.double(11), -11.0);
  });

  tester.addTest('array_as_double', function() {
    assertRaises(function() { server.double(new Array(10)); });
  });

  tester.addTest('int_passret', function() {
    var ival = 12345;
    assertEqual(server.int(ival), -ival);
  });

  tester.addTest('bool_as_int', function() {
    assertRaises(function() { server.int(true); });
    assertRaises(function() { server.int(false); });
  });

  tester.addTest('double_as_int', function() {
    assertEqual(server.int(11.0), -11);
    assertEqual(server.int(11.1), -11);
    assertEqual(server.int(11.9), -11);
    assertEqual(server.int(-11.0), 11);
    assertEqual(server.int(-11.1), 11);
    assertEqual(server.int(-11.9), 11);
  });

  tester.addTest('array_as_int', function() {
    assertRaises(function() { server.int(new Array(10)); });
  });
}


// Tests passing array types.
function ArrayTypes(tester, server) {

  var reverse = function(array) {
    // array.slice(0) is a JS idiom for cloning an array.
    return array.slice(0).reverse();
  }

  tester.addTest('chararr_passret', function() {
    var carr = [ 72, 101, 108, 108, 111 ];  // Hello
    // Sanity check
    assert(isArray(carr), 'carr is not an Array');
    var ret_arr = server.char_array(carr, 5);
    // http://code.google.com/p/nativeclient/issues/detail?id=1367
    //assert(isArray(ret_arr), 'ret_arr is not an Array');
    assertArraysEqual(ret_arr, reverse(carr));
  });

  tester.addTest('bool_as_char_array', function() {
    assertRaises(function() { return server.char_array(true); });
  });

  tester.addTest('int_as_char_array', function() {
    assertRaises(function() { return server.char_array(11); });
  });

  tester.addTest('double_as_char_array', function() {
    assertRaises(function() { return server.char_array(1.5); });
  });

  tester.addTest('doublearr_passret', function() {
    var darr = [3.1, 1.4, 4.1, 1.5, 5.9];
    var ret_arr = server.double_array(darr, 5);
    assertArraysEqual(ret_arr, reverse(darr));
  });

  tester.addTest('bool_as_double_array', function() {
    assertRaises(function() { return server.double_array(true); });
  });

  tester.addTest('int_as_double_array', function() {
    assertRaises(function() { return server.double_array(1); });
  });

  tester.addTest('double_as_double_array', function() {
    assertRaises(function() { return server.double_array(1.0); });
  });

  tester.addTest('intarr_passret', function() {
    var iarr = [1, 2, 3, 4, 5];
    var ret_arr = server.int_array(iarr, 5);
    assertArraysEqual(ret_arr, reverse(iarr));
  });

  tester.addTest('bool_as_int_array', function() {
    assertRaises(function() { return server.int_array(true); });
  });

  tester.addTest('int_as_int_array', function() {
    assertRaises(function() { return server.int_array(1); });
  });

  tester.addTest('double_as_int_array', function() {
    assertRaises(function() { return server.int_array(1.0); });
  });
}


// Tests passing more complex or special-purpose types.
function SpecialTypes(tester, server) {

  tester.addTest('string_send', function() {
    var str = 'one more test';
    assertEqual(str.length, server.string(str));
  });

  tester.addTest('string_return', function() {
    assertEqual('string', typeof(server.stringret(0)));
  });

  tester.addTest('bool_as_string', function() {
    assertRaises(function() { return server.string(true); });
  });

  tester.addTest('int_as_string', function() {
    assertRaises(function() { return server.string(1); });
  });

  tester.addTest('double_as_string', function() {
    assertRaises(function() { return server.string(1.0); });
  });

  tester.addTest('array_as_string', function() {
    assertRaises(function() { return server.string([1, 2, 3, 4, 5]); });
  });

  tester.addTest('handle_return', function() {
    assertEqual('object', typeof(server.handleret()));
  });

  tester.addTest('invalid_handle_return', function() {
    var ret = server.invalid_handle_ret();
    assertEqual('object', typeof(ret));
    server.invalid_handle(ret);  // Testing this does not fail.
  });

  tester.addTest('bool_as_handle', function() {
    assertRaises(function() { return server.handle(true); });
  });

  tester.addTest('int_as_handle', function() {
    assertRaises(function() { return server.handle(1); });
  });


  tester.addTest('double_as_handle', function() {
    assertRaises(function() { return server.handle(1.0); });
  });

  tester.addTest('array_as_handle', function() {
    assertRaises(function() { return server.handle([1, 2, 3, 4, 5]); });
  });
}

function ISATest(tester, server) {
  tester.addTest('get_sandbox_isa', function() {
    var isa_string = server.__getSandboxISA();
    tester.log('Got sandbox ISA identifier: ' + isa_string);
    // Unfortunately, I don't know how to test the ground-truth.
    // At least we can test that it does not return garbage.
    assert(isa_string == "x86-32"
           || isa_string == "x86-64"
           || isa_string == "arm");
  });
}
    </script>
  </head>
  <body>
    <h1> SRPC Parameter Passing Test</h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.

    <embed type="application/x-nacl" id="nacl_server"
           name="nacl_module" width="0" height="0" src="srpc_test.nmf" />

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      var server = $("nacl_server");
      ScalarTypes(tester, server);
      ArrayTypes(tester, server);
      SpecialTypes(tester, server);
      ISATest(tester, server);
      tester.waitFor(server);
      tester.run();
      //]]>
    </script>
  </body>
</html>
