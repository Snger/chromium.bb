<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2008 Google Inc.  All rights reserved. -->
  <head>
    <title>SRPC Open URL as NaCl Descriptor Test</title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[
function enqueueTests(tester, server) {
  tester.addTest('nonexistent_file_load', function() {
    var callbackDone = false;
    var testPassed;
    function InvalidCallback() {
      this.onload = function(nacl_desc) {
        testPassed = false;
        callbackDone = true;
      }
      this.onfail = function(object) {
        testPassed = true;
        callbackDone = true;
      }
    }
    // Load of an invalid URL (which should not work).
    var url = 'url_as_nacl_desc_nonexistent_url.html';
    server.__urlAsNaClDesc(url, new InvalidCallback());
    function wait() {
      if (!callbackDone) {
        halt_and_callback(1, wait);
      } else {
        assertEqual(testPassed, true);
      }
    }
    wait();
  });

  tester.addTest('cross_origin_load', function() {
    var callbackDone = false;
    var testPassed;
    function CrossOriginCallback() {
      this.onload = function(nacl_desc) {
        testPassed = false;
        callbackDone = true;
      }
      this.onfail = function(object) {
        testPassed = true;
        callbackDone = true;
      }
    }
    // Load of a cross-origin file (which should not work).
    var url = 'http://www.google.com/robots.txt';
    server.__urlAsNaClDesc(url, new CrossOriginCallback());
    function wait() {
      if (!callbackDone) {
        halt_and_callback(1, wait);
      } else {
        assertEqual(testPassed, true);
      }
    }
    wait();
  });

  tester.addTest('valid_file_load', function() {
    var callbackDone = false;
    var fileString = '';
    function ValidCallback() {
      this.onload = function(nacl_desc) {
        // Get the data that was loaded from the file.
        var msg = server.cat(nacl_desc, 4096);
        var len = msg.length;
        var byte;
        for (var i = 0; i < len && (byte = msg[i]) != 0; i++) {
          fileString += String.fromCharCode(byte);
        }
        callbackDone = true;
      }
      this.onfail = function(object) {
        callbackDone = true;
      }
    }
    // Load of a valid file.
    var url = 'srpc_url_as_nacl_desc_success.html';
    server.__urlAsNaClDesc(url, new ValidCallback());
    function wait() {
      if (!callbackDone) {
        halt_and_callback(1, wait);
      } else {
        var expected_text = 'TEST PASSED';
        assert(fileString.indexOf(expected_text) >= 0);
      }
    }
    wait();
  });
}
      //]]>
    </script>
  </head>
  <body>
    <h1>SRPC Open URL as NaCl Descriptor Test</h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.

    <embed type="application/x-nacl" id="nacl_server" name="naclModule"
           width="0" height="0" src="cat.nmf" />
    <script type="application/x-javascript">
      //<![CDATA[
var tester = new Tester();
enqueueTests(tester, $('nacl_server'));
tester.waitFor($('nacl_server'));
tester.run();
      //]]>
    </script>
  </body>
</html>
