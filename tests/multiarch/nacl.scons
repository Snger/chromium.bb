# -*- python -*-
# Copyright 2011 The Native Client Authors.  All rights reserved.
# Use of this source code is governed by a BSD-style license that can
# be found in the LICENSE file.

# Test of selection of the most appropriate nexe for a given CPU
# architecture.

Import('env')

# BUG(adonovan): test is breaking on ARM.  Disable in haste...
if env.Bit('target_arm'):
  Return()

# Use pre-built "Hello, World!" executables for several architectures.
node = env.PPAPIBrowserTester(
    'multiarch_test.out',
    url='multiarch.html',
    files=[env.File('multiarch.html'),
           env.File('multiarch.js'),
           env.File('multiarch.nmf'),
          ],
    # The prebuilt nexes should NOT be wrapped in env.File, otherwise they will
    # become dependancies.  When they become dependancies, this will trigger
    # AddPrebuiltBinaryToRepository and cause the nexe to be built and installed
    # into the prebuilt directory.
    map_files=[('x86/srpc_hw.nexe',
                 '${SCONSTRUCT_DIR}/tests/prebuilt/x86/srpc_hw.nexe'),
               ('x64/srpc_hw.nexe',
                 '${SCONSTRUCT_DIR}/tests/prebuilt/x64/srpc_hw.nexe'),
               ('arm/srpc_hw.nexe',
                 '${SCONSTRUCT_DIR}/tests/prebuilt/arm/srpc_hw.nexe'),
              ],
    )


# TODO(ncbray) reenable
# http://code.google.com/p/nativeclient/issues/detail?id=1623
buggy = env.Bit('host_windows')

env.AddNodeToTestSuite(node,
                       ['chrome_browser_tests'],
                       'run_multiarch_test',
                       is_broken=env.PPAPIBrowserTesterIsBroken() or buggy)
