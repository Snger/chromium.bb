<!--
  Copyright 2010 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->

<script type="text/javascript" src="nacltest.js"></script>

<div id="scratch_space"></div>

<div id="load_warning">
Javascript has failed to load.
</div>

<script type="text/javascript">

function addTest(tester, url) {
  tester.addAsyncTest(url, function(status) {
    var embed = document.createElement('embed');
    embed.width = 0;
    embed.height = 0;
    embed.src = url;
    embed.type = 'application/x-nacl';
    embed.name = 'foo';

    // Webkit Bug Workaround
    // THIS SHOULD BE REMOVED WHEN Webkit IS FIXED
    // http://code.google.com/p/nativeclient/issues/detail?id=2428
    // http://code.google.com/p/chromium/issues/detail?id=103588
    ForcePluginLoadOnTimeout(embed, tester, 15000);

    var div = document.createElement('div');
    div.appendChild(embed);

    // Wait for the load event, which indicates successful loading.
    div.addEventListener('load', status.wrap(function(e) {
      status.log('Loaded ' + embed.src);
      // Make sure the plugin is working OK.
      var result = embed.run_tests();
      status.log(result);
      status.assertEqual(result, 'passed');
      status.pass();
    }), true);

    div.addEventListener('error', status.wrap(function(e) {
      status.fail(embed.lastError);
    }), true);

    // Insert div into the DOM.  This starts the load of the nacl plugin, etc.
    document.getElementById('scratch_space').appendChild(div);
  });
}

// Remove the "failed to load" message.
document.getElementById('load_warning').innerHTML = '';

var tester = new Tester();
addTest(tester, 'dynamic_load_test.nmf');
addTest(tester, 'dynamic_modify_test.nmf');
addTest(tester, 'imc_shm_mmap_test.nmf');
tester.runParallel();

</script>
