<!--
  Copyright 2010 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->

<script type="text/javascript" src="nacltest.js"></script>

<div id="scratch_space"></div>

<div id="load_warning">
Javascript has failed to load.
</div>

<script type="text/javascript">

// tools/selenium_tester.py polls nacllib.getStatus() to find out when
// the test has completed.
var selenium_status = 'WAIT';
var log_text = '';
nacllib = {
  getMessage: function() {
    return log_text;
  },
  getStatus: function() {
    return selenium_status;
  },
};

var rpc = new RPCWrapper();

function log(message) {
  log_text += message + '\n';
}

function startProcess(url, callback) {
  var embed = document.createElement('embed');
  embed.width = 0;
  embed.height = 0;
  embed.src = url;
  embed.type = 'application/x-nacl';
  embed.name = 'foo';

  var div = document.createElement('div');
  div.appendChild(embed);
  // Wait for the load event, which indicates successful loading.
  div.addEventListener('load', (function(e) { callback(e.target) }) , true);

  // Insert div into the DOM.  This starts the load of the nacl plugin, etc.
  document.getElementById('scratch_space').appendChild(div);
}

function runTest(url, callback) {
  rpc.begin(url);
  log(url + ': running...');
  startProcess(url, function(plugin) {
    rpc.log(url, 'process has started...');
    log(url + ': process has started...');
    try {
      var result = plugin.run_tests();
      rpc.log(url, result);
      log(url + ': ' + result);
      if (result == 'passed') {
        rpc.pass(url);
        log(url + ': passed');
      } else {
        rpc.fail(url, result);
        log(url + ': failed: ' + result);
      }
      callback(result == 'passed');
    } catch(e) {
      rpc.exception(url, e);
      log(url + ': failed with exception: ' + result);
      callback(false);
    }
  });
}

function runAllTests() {
  // Remove the "failed to load" message.
  document.getElementById('load_warning').innerHTML = '';
  log('Starting NaCl test runner...');

  var test_count = 0;
  var failed_count = 0;
  var finished_count = 0;

  function onCompletion(passed) {
    finished_count++;
    if (!passed) {
      failed_count++;
    }

    if (finished_count == test_count) {
      log('Ran ' + test_count + ' tests');
      if (failed_count == 0) {
        log('PASSED');
        selenium_status = 'SUCCESS';
      } else {
        log(failed_count + ' FAILURE(S)');
        selenium_status = 'FAILED';
      }
      rpc.blankLine();
      rpc.shutdown();
    }
  }
  function addTest(url) {
    test_count++;
    runTest(url, onCompletion);
  }

  rpc.startup();
  rpc.blankLine();
  addTest('dynamic_load_test.nmf');
  addTest('dynamic_modify_test.nmf');
  addTest('imc_shm_mmap_test.nmf');
}

window.onload = runAllTests;

</script>
