<!--
  Copyright 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->
<!DOCTYPE html>
<html>

<head>
  <title>NaCl async messaging test</title>
  <script type="text/javascript" src="nacltest.js"></script>
</head>

<body>
  <div id="listener">
    <script type="text/javascript">
      function onProcessStart() {
        bodyProcessStart();
      }
      // Set a listener for embed load events.
      $('listener').addEventListener('load', onProcessStart, true);
    </script>

    <embed id="nacl_plugin" width=0 height=0
           type="application/x-nacl" nacl="async_message_test.nmf" />
  </div>
  <embed id="dormant_plugin" width=0 height=0 type="application/x-nacl" />

<div id="load_warning">
Javascript has failed to load.
</div>

<script type="text/javascript">

var rpc = new RPCWrapper();

// In Firefox, synchronous XMLHttpRequest appears to be re-entrant: it
// can cause asyncCallback() to be re-entered.  This means we end up
// processing the messages in reverse order, which makes the test fail.
// So disable use of synchronous XHR.
rpc.async = true;


function log(message) {
  rpc.log('async_messaging.html', message);
}

var expected_messages = [
    'Aye carumba! This is an async message.',
    'Message\0containing\0NULLs\0',
    'Top-bit-set bytes: \x80 and \xff',
    'Echoed: hello world!',
    'Received 8 bytes, 1 FDs',
    ];
var current_index = 0;

function asyncCallback(data) {
  log('Received callback: "' + data + '"');
  if (data == expected_messages[current_index]) {
    current_index++;
    log('Matched message ' + current_index +
        ' of ' + expected_messages.length + ' OK');
  } else {
    rpc.fail('test',
             'Mismatch: ' + data + ' != ' + expected_messages[current_index]);
  }
  if (current_index == expected_messages.length) {
    rpc.pass('async_messaging.html', 'Passed');
    rpc.shutdown();
  }
}

function dummyCallback(data) {
}

function assertRaisesMessage(expected_error, func) {
  try {
    func();
  } catch (error) {
    // The error message does not propagate through properly in Chromium
    // at the moment.  The second case here is to handle that.
    // TODO(mseaborn): Get the error propagation fixed.
    // See http://code.google.com/p/nativeclient/issues/detail?id=1483
    if (error != expected_error &&
        error != 'Error: Error calling method on NPObject.') {
      rpc.fail('test', 'Did not get expected exception: ' + error);
    }
    return;
  }
  rpc.fail('test', 'Did not get exception');
}

function bodyProcessStart() {
  rpc.startup();
  log('NaCl process started');
  var plugin = document.getElementById('nacl_plugin');
  plugin.__setAsyncCallback(asyncCallback);

  // Attempting to register another callback should be rejected.  The
  // plugin should not spawn two threads to listen on the same socket.
  assertRaisesMessage(
      'A callback has already been registered',
      function() { plugin.__setAsyncCallback(dummyCallback); });

  var dormant_plugin = document.getElementById('dormant_plugin');
  assertRaisesMessage(
      'No subprocess running',
      function() { dormant_plugin.__setAsyncCallback(dummyCallback); });

  // Test attempting to send strings that cannot be converted to byte
  // strings.  These should be rejected.
  assertRaisesMessage(
      'Invalid string',
      function() { plugin.__sendAsyncMessage0('Char too big: \u0100'); });

  // Check use of an invalid argument type.
  // TODO(mseaborn): We should get a more informative error here.
  // See also http://code.google.com/p/nativeclient/issues/detail?id=1483
  assertRaisesMessage(
      'Error: Error calling method on NPObject!',
      function() { plugin.__sendAsyncMessage0(123); });

  // Check use of a non-file-descriptor type.
  // TODO(mseaborn): We should get a "not a file descriptor" error here.
  // See also http://code.google.com/p/nativeclient/issues/detail?id=1483
  assertRaisesMessage(
      'Error: Error calling method on NPObject!',
      function() { plugin.__sendAsyncMessage1('foo', {}); });

  plugin.__sendAsyncMessage0('hello world!');
  plugin.__sendAsyncMessage1('with fds', plugin.__defaultSocketAddress());
  log('Sent messages OK');
}

function onPageLoad() {
  // Remove the "failed to load" message.
  document.getElementById('load_warning').innerHTML = '';
  log('Page loaded');
}

window.onload = onPageLoad;

</script>

</body>
</html>
