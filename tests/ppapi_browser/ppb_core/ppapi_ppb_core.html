<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <!-- Copyright 2011 Google Inc.  All rights reserved. -->
  <head>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[
      function setupTests(tester, plugin) {
        // This function takes an array of messages and asserts that the nexe
        // calls PostMessage with each of these messages, in order.
        function expectMessages(test, plugin, messages) {
          var messages_array = messages
          var listener = test.wrap(function(message) {
            plugin.removeEventListener('message', listener, false);
            test.assertEqual(message.data, messages_array.shift())
            if (messages_array.length == 0)
              test.pass();
            else
              plugin.addEventListener('message', listener, false);
          });
          plugin.addEventListener('message', listener, false);
        }

        // Note: this function can take multiple arguments after test_name.
        // Each subsequent argument is the expected additional response
        // from the nexe (aside from the usual 'test_name:PASSED' response).
        function addTest(test_name) {
          // Convert all the arguments to this function into a proper Array
          var expected_messages = [].slice.call(addTest.arguments);
          expected_messages[0] = test_name + ':PASSED';
          tester.addAsyncTest('PPB_Core::' + test_name, function(test) {
            expectMessages(test, plugin, expected_messages);
            plugin.postMessage(test_name)
          });
        }

        addTest('TestGetTime');
        addTest('TestGetTimeTicks');
        addTest('TestIsMainThread_FromMainThread');
        addTest('TestIsMainThread_FromNonMainThread');
        addTest('TestAddRefAndReleaseResource');
        addTest('TestAddRefAndReleaseInvalidResource');
        addTest('TestCallOnMainThread_FromMainThread',
                'CallOnMainThreadCallback_FromMainThread');
        addTest('TestCallOnMainThread_FromMainThreadDelayed',
                'CallOnMainThreadCallback_FromMainThreadDelayed');
        addTest('TestCallOnMainThread_FromNonMainThread',
                'CallOnMainThreadCallback_FromNonMainThread');
        addTest('TestCallOnMainThread_FromNonMainThreadStress',
                'CallOnMainThreadCallback_ThreadStress');
      }
      //]]>
    </script>
    <title>PPAPI PPB_Core Test</title>
  </head>
  <body>
    <h1>PPAPI PPB_Core Test</h1>

    <embed type="application/x-nacl" id="test_nexe"
           name="nacl_module"
           src="ppapi_ppb_core.nmf"
           width="0" height="0" />

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      setupTests(tester, $('test_nexe'));
      tester.waitFor($('test_nexe'));
      tester.run();
      //]]>
    </script>
  </body>
</html>
