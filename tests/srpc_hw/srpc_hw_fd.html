<!DOCTYPE html>
<html>
  <head>
    <title>SRPC Simple Plug-in</title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[

function loadAndTestMethods(tester, server) {
  tester.addTest('load_and_run_methods', function() {
    // Variables to hold the response.
    var responded = false;
    var nexe_file_descriptor_object = undefined;

    var Callback = function() {
      this.onload = function(fd) {
        nexe_file_descriptor_object = fd;
        responded = true;
      },
      this.onfail = function(message) {
      }
    };

    // Make the request.
    server.__urlAsNaClDesc('srpc_hw.nexe', new Callback());

    function waitForStaticLoad() {
      if (!responded) {
        // Periodically poll until the results are ready.
        halt_and_callback(5, waitForStaticLoad);
      } else {
        // Validate the results of the static load.
        tester.log(nexe_file_descriptor_object);
        // When __launchExecutableFromFd is called, it causes the set of
        // progress events to be dispatched.  On successful loading a 'load'
        // event will be dispatched.  We keep a variable to indicate whether
        // the 'loadend' event has been dispatched and poll. An event listener
        // changes the success/fail variable when the 'load' event is received.
        var loadedFromFdEnded = false;
        var loadedFromFdSucceeded = false;
        $('nacl_server').addEventListener('loadend',
            function() { loadedFromFdEnded = true; }, true);
        $('nacl_server').addEventListener('load',
            function() { loadedFromFdSucceeded = true; }, true);
        // Start the load from the nexe file descriptor object.
        server.__launchExecutableFromFd(nexe_file_descriptor_object);
        // Wait until the variable indicates the load event was received.
        function waitForLoadFromFd() {
          if (!loadedFromFdEnded) {
            // Periodically poll until the results are ready.
            halt_and_callback(5, waitForLoadFromFd);
          } else {
            assert(loadedFromFdSucceeded);
            assertEqual(42, server.fortytwo());
            assertEqual('hello, world.', server.helloworld());
          }
        }
        waitForLoadFromFd();
      }
    }
    waitForStaticLoad();
  });
}

      //]]>
    </script>
  </head>
  <body id="bodyId">
    <h1>Native Client SRPC Plug-in from a File Descriptor</h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.

    <embed type="application/x-nacl" id="nacl_server"
           name="nacl_module" width="0" height="0" src="srpc_hw.nmf" />

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      var server = $("nacl_server");
      loadAndTestMethods(tester, server);
      tester.waitFor(server);
      tester.run();
      //]]>
    </script>
  </body>
</html>
