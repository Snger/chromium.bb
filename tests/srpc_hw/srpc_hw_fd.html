<!DOCTYPE html>
<html>
  <head>
    <title>SRPC Simple Plug-in</title>
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
    <META HTTP-EQUIV="Expires" CONTENT="-1" />
    <script type="text/javascript" src="nacltest.js"></script>
    <script type="application/x-javascript">
      //<![CDATA[

function loadAndTestMethods(tester, server) {
  tester.addAsyncTest('load_and_run_methods', function(status) {
    var Callback = function() {
      this.onload = status.wrap(function(fd) {
        // Validate the results of the static load.
        status.assert(fd);

        // When __launchExecutableFromFd is called, it causes the set of
        // progress events to be dispatched.  On successful loading a 'load'
        // event will be dispatched.  The 'loadend' event should always be
        // dispatched at the end of loading.

        var loadedFromFdSucceeded = false;
        server.addEventListener('load', function() {
          loadedFromFdSucceeded = true;
        }, true);

        server.addEventListener('loadend', status.wrap(function() {
          status.assert(loadedFromFdSucceeded);
          status.assertEqual(4, server.readyState);
          status.assertEqual('', server.lastError);
          status.assertEqual(42, server.fortytwo());
          status.assertEqual('hello, world.', server.helloworld());
          status.pass();
         }), true);

        // Start the load from the nexe file descriptor object.
        server.__launchExecutableFromFd(fd, (function(s) { }));
      }),

      this.onfail = status.wrap(function(message) {
        status.fail('Failed to fetch URL.');
      })
    };

    // Make the request.
    server.__urlAsNaClDesc('srpc_hw.nexe', new Callback());
  });
}

      //]]>
    </script>
  </head>
  <body id="bodyId">
    <h1>Native Client SRPC Plug-in from a File Descriptor</h1>
    NOTE: Set NACL_ENABLE_EXPERIMENTAL_JAVASCRIPT_APIS=1 to run this test.

    <embed type="application/x-nacl" id="nacl_server"
           name="nacl_module" width="0" height="0"/>

    <script type="text/javascript">
      //<![CDATA[
      var tester = new Tester();
      var server = $('nacl_server');
      loadAndTestMethods(tester, server);
      tester.run();
      //]]>
    </script>
  </body>
</html>
