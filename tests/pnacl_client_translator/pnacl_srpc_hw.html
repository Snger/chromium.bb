<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
  Copyright (c) 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
-->
<html>
<head>
  <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
  <META HTTP-EQUIV="Expires" CONTENT="-1" />
  <title>PNACL Hello World Test</title>
  <script type="text/javascript" src="nacltest.js"></script>
  <script type="text/javascript" src="pnacl_support/pnacl_coordinator.js">
  </script>
  <script type="text/javascript">
    //<![CDATA[

    function pageDidLoad() {
      var tester = new Tester();
      var nexeModule = $('nexe_id');

      // Create the utility embed tags (e.g., llc). Wait for them to be ready.
      var pnaclEmbeds = injectUtilityEmbeds();
      tester.waitFor.apply(tester, pnaclEmbeds.getEmbedsToWaitFor());

      // Uncomment the following waitFor() if you want to see some sad-tabs.
      // c.f. http://code.google.com/p/nativeclient/issues/detail?id=1510
      // You don't really need to wait for this module, since we are already
      // gating the tests with 'var translated', but trying to wait for
      // it helps reproduce a bug.
      //tester.waitFor(nexeModule);

      tester.addTest('pnacl_translate', function() {
        // Flag to determine when translation is done.
        var translated = false;

        function wait() {
          if (!translated) {
            halt_and_callback(100, wait);
          } else {
            tester.log('Done waiting for translation.');
            assertEqual(nexeModule.fortytwo(), 42);
            assertEqual(nexeModule.helloworld(), 'hello, world.');
          }
        }

        // Translation will call this when the nexe is translated and loaded.
        function finishCallback() {
          enableButton('fortytwo');
          enableButton('helloworld');
          translated = true;
        }

        // Start translation and wait for it to finish.
        startLoading(finishCallback, nexeModule, pnaclEmbeds);
        wait();
      });

      tester.run();
    }

    // Assume that tester.waitFor will ensure pnacl embeds are ready.
    // Thus, by the time we get to this we are ready to go!
    function startLoading(finishCallback, nexeModule, pnaclEmbeds) {
      pnaclTranslatorInit('pnacl_srpc_hw.pexe',
                          pnaclEmbeds,
                          nexeModule,
                          finishCallback);
    }

    function enableButton(id) {
      var button = $(id);
      button.disabled = null;
    }

    function fortytwo() {
      var result = "";
      try {
        result = $('nexe_id').fortytwo();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

    function helloworld() {
      var result = "";
      try {
        result = $('nexe_id').helloworld();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

//]]>
  </script>
</head>
<body onload="pageDidLoad()">

  <h1>PNACL SRPC Hello World Test</h1>

  <!-- This is a place holder for running the hello_world bitcode,
       so the src attribute is not specified.
       TODO(jvoung): This should look like any other NaCl nmf embed.
    -->
  <embed type="application/x-nacl" id="nexe_id"
          width="0" height="0" />

  <div id="hello_ui">
    <p>
      <button id='fortytwo' onclick='fortytwo()' disabled='disabled'>
        Call fortytwo()</button>
      <button id='helloworld' onclick='helloworld()' disabled='disabled'>
        Call helloworld()</button>
    </p>
  </div>

</body>
</html>
