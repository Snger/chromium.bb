<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
  Copyright (c) 2011 The Native Client Authors. All rights reserved.
  Use of this source code is governed by a BSD-style license that can be
  found in the LICENSE file.
-->
<html>
<head>
  <META HTTP-EQUIV="Pragma" CONTENT="no-cache" />
  <META HTTP-EQUIV="Expires" CONTENT="-1" />
  <title>PNACL Hello World Test</title>
  <script type="text/javascript" src="nacltest.js"></script>
  <script type="text/javascript">
    //<![CDATA[

    function setupTests() {
      var tester = new Tester();
      var nexeModule = $('nexe_id');

      tester.waitFor(nexeModule);

      tester.addTest('pnacl_translate', function() {
        tester.log('Done waiting for translation.');
        enableButton('fortytwo');
        enableButton('helloworld');
        assertEqual(nexeModule.fortytwo(), 42);
        assertEqual(nexeModule.helloworld(), 'hello, world.');
      });
      tester.run();
    }

    function enableButton(id) {
      var button = $(id);
      button.disabled = null;
    }

    function fortytwo() {
      var result = "";
      try {
        result = $('nexe_id').fortytwo();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

    function helloworld() {
      var result = "";
      try {
        result = $('nexe_id').helloworld();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

    function pageDidLoad() {
      // Set up a ticker so that we know that the UI thread is not blocked.
      var startTime = (new Date).getTime();
      var updateUI = function() {
         var counter_div = $("counter_area");
         var now = (new Date).getTime();
         counter_div.innerText = String(now - startTime);
         setTimeout(updateUI, 100);
      }
      setTimeout(updateUI, 100);

      var updateProgress = function() {
         var progress_div = $("progress_area");
         progress_div.innerText += ".";
      }
      var nexe_div = $("nexe_id");
      nexe_div.addEventListener("loadstart", updateProgress, true);
      nexe_div.addEventListener("progress", updateProgress, true);
      nexe_div.addEventListener("load", updateProgress, true);
      nexe_div.addEventListener("loadend", updateProgress, true);
    }
//]]>
  </script>
</head>
<body onload="pageDidLoad()">

  <h1>PNACL SRPC Hello World Test</h1>
  <embed type="application/x-nacl" id="nexe_id"
          width="0" height="0" src="pnacl_srpc_hw.nmf" />
    <script type="text/javascript">
      //<![CDATA[
      setupTests();
      //]]>
    </script>


  <div id="hello_ui">
    <p>
      <button id='fortytwo' onclick='fortytwo()' disabled='disabled'>
        Call fortytwo()</button>
      <button id='helloworld' onclick='helloworld()' disabled='disabled'>
        Call helloworld()</button>
    </p>
  </div>

  <p> This should tick when the UI thread is not blocked:</p>
  <div id="counter_area"> 0.0 </div>

  <p> Progress:</p>
  <div id="progress_area" style="font-size:28pt; color:#FF9900;"> </div>

</body>
</html>
