<!DOCTYPE html>
<!--
  Copyright 2011 Google Inc. All rights reserved.
  Use of this source code is governed by a BSD-style license that can
  be found in the LICENSE file.
-->
<html>
<head>
  <meta charset="utf-8" />
  <title>Client Translator Hello World Test</title>
  <script src="pnacl_coordinator.js"></script>
  <script type="text/javascript">
    //<![CDATA[

    // All the translator nexes that should load before trying to translate.
    llcModule = null;
    ldModule = null;

    // Test harness stuff cribbed from other examples.
    statusText = 'NO-STATUS';

    // If the page loads before the Native Client module loads, then set the
    // status message indicating that the module is still loading. Otherwise,
    // do not change the status message.
    function pageDidLoad() {
      llcModule = document.getElementById('llc_nexe_id');
      ldModule = document.getElementById('ld_nexe_id');

      if (llcModule == null || !llcModule.__moduleReady) {
        updateStatus('LOADING LLC...');
        setTimeout('pageDidLoad()', 300);
      } else if (ldModule == null || !ldModule.__moduleReady) {
        updateStatus('LOADING LD...');
        setTimeout('pageDidLoad()', 300);
      } else {
        updateStatus('LOADED LLC and LD SUCCESSFULLY! NOW TRANSLATING...');
        PnaclTranslatorInit('hello_world.pexe',
                            'llc_nexe_id',
                            'ld_nexe_id',
                            'nexe_id',
                            finishCallback);
      }
    }

    function updateStatus(opt_message) {
      if (opt_message)
        statusText = opt_message;
      var statusField = document.getElementById('status_field');
      if (statusField) {
        statusField.textContent = statusText;
      }
    }

    var EnableButton = function(id) {
      var button = document.getElementById(id);
      button.disabled = null;
    }

    function fortytwo() {
      var result = "";
      try {
        result = document.getElementById('nexe_id').fortytwo();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

    function helloworld() {
      var result = "";
      try {
        result = document.getElementById('nexe_id').helloworld();
      } catch(e) {
        result = "ERROR: " + e;
      }
      alert("" + result);
    }

    // Translation script will call this when the nexe is translated and loaded.
    function finishCallback() {
      EnableButton('fortytwo');
      EnableButton('helloworld');
      updateStatus('Translated and Loaded Nexe');
    }
//]]>
  </script>
</head>
<body onload="pageDidLoad()">

  <h1>PNaCl srpc_hw test</h1>

  <!-- TODO: Try not to expose theese embed elements for llc / ld.
       This is especially the case if we fuse llc and ld in the future.
       TODO: Use ISA chooser / nmf to pick the LLC version.
       For now we have hardcoded 64bit arguments into the nexes...
    -->
  <embed type="application/x-nacl" id="llc_nexe_id"
          width="0" height="0" src="llc-x86-64.nexe">

  <embed type="application/x-nacl" id="ld_nexe_id"
          width="0" height="0" src="ld-x86-64.nexe">

  <!-- This is a place holder for running the hello_world bitcode,
       so the src attribute is not specified.
       TODO: Perhaps this place holder should point to a ".nmf" with
       PNaCl extensions. That would replace then inject the above embeds
       if needed...
       The .nmf would specify the bitcode file and the needed dependencies.
    -->
  <embed type="application/x-nacl" id="nexe_id"
          width="0" height="0">

  <!-- Wait for translation to happen, then call the HelloWorld function -->

  <div id="status_field">
    <p>NO-STATUS</p>
  </div>

  <div id="hello_ui">
    <p>Hello World UI goes here</p>
    <p>
      <button id='fortytwo' onclick='fortytwo()' disabled='disabled'>
        Call fortytwo()</button>
      <button id='helloworld' onclick='helloworld()' disabled='disabled'>
        Call helloworld()</button>
    </p>

  </div>

  <div id="general_log_area">
    <p> LOG STUFF HERE: </p>
  </div>


</body>
</html>
