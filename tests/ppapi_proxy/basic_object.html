<!DOCTYPE html>
<html>
<!-- Copyright (c) 2010 The Native Client Authors. All rights reserved.
     Use of this source code is governed by a BSD-style license that can be
     found in the LICENSE file. -->
<head>
  <title>PPAPI Runtime Feature Test</title>
  <meta HTTP-EQUIV="Pragma" CONTENT="no-cache" />
  <meta HTTP-EQUIV="Expires" CONTENT="-1" />
  <script type="text/javascript" src="nacltest.js"></script>
</head>
<body>

<script type="text/javascript">
//<![CDATA[

var kSampleInt = 1;
var kSampleString = 'hello, world';
var kSampleObject = new Array(10);


function EnqueueTests(naclModule, suffix) {
  // Test access to NaCl ppruntime objects from the browser.
  // Read a property that is not set.
  tester.addTest('browser_nacl_read_notset' + suffix, function() {
    assertEqual(naclModule.propertyUnset, undefined);
  });

  // Read a property that is set.
  tester.addTest('browser_nacl_read_set' + suffix, function() {
    assertEqual(naclModule.propNull, null);
  });

  // Write and read back an integer property.
  tester.addTest('browser_nacl_int_property' + suffix, function() {
    naclModule.propInt32 = 7;
    assertEqual(naclModule.propInt32, 7);
    naclModule.propInt32 = 11;
    assertEqual(naclModule.propInt32, 11);
  });

  // Read back the property.
  tester.addTest('browser_nacl_string_property' + suffix, function() {
    naclModule.propString = 'hello';
    assertEqual(naclModule.propString, 'hello');
    naclModule.propString = 'world';
    assertEqual(naclModule.propString, 'world');
  });

  // Broken, throws an exception.
  // TODO(ncbray) fix or remove.
  /*
  tester.addTest('browser_nacl_object_double_deref' + suffix, function() {
    naclModule.propObject = kSampleObject;
    var temp1 = naclModule.propObject;
    var temp2 = naclModule.propObject;
    // The second deref has throw an exception, in the past.
  });
  */

  // Broken, corrupted object returned.
  // TODO(ncbray) fix or remove.
  // http://code.google.com/p/nativeclient/issues/detail?id=1367
  /*
  // Write and read back an object property.
  tester.addTest('browser_nacl_object_write' + suffix, function() {
    naclModule.propObject = kSampleObject;
    assertEqual(naclModule.propObject, kSampleObject);
  });
  */

  // Argument passing and return.
  tester.addTest('browser_nacl_int_argret' + suffix, function() {
    assertEqual(naclModule.methodInt32(13), 13);
  });
  
  tester.addTest('browser_nacl_string_argret' + suffix, function() {
    assertEqual(naclModule.methodString('bogus'), 'bogus');
  });

  // Broken, corrupted object returned.
  // TODO(ncbray) fix or remove.
  // http://code.google.com/p/nativeclient/issues/detail?id=1367
  /*
  tester.addTest('browser_nacl_object_argret' + suffix, function() {
    assertEqual(naclModule.methodObject(kSampleObject), kSampleObject);
  });
  */

  // Multi-argument passing and return.
  tester.addTest('browser_nacl_int_2_argret' + suffix, function() {
    assertEqual(naclModule.methodInt32With2Args(kSampleInt, kSampleInt),
                kSampleInt);
  });

  tester.addTest('browser_nacl_string_2_argret' + suffix, function() {
    assertEqual(naclModule.methodStringWith2Args(kSampleString, kSampleString),
                kSampleString);
  });
  
  // Broken, corrupted object returned.
  // TODO(ncbray) fix or remove.
  // http://code.google.com/p/nativeclient/issues/detail?id=1367
  /*
  tester.addTest('browser_nacl_object_2_argret' + suffix, function() {
    assertEqual(naclModule.methodObjectWith2Args(kSampleObject, kSampleObject),
                kSampleObject);
  });
  */

  // Broken, returns "hell"
  // TODO(ncbray) fix or remove.
  // http://code.google.com/p/nativeclient/issues/detail?id=1456
  /*
  // Call a method with 0 args (tests issue:
  // http://code.google.com/p/nativeclient/issues/detail?id=891)
  tester.addTest('browser_nacl_0_argret' + suffix, function() {
    assertEqual(naclModule.helloWorld(), 'hello, world');
  });
  */

  tester.addTest('nacl_browser_window_location_prop', function() {
    assertEqual(naclModule.windowLocation(window), true);
  });
}


//]]>
</script>

<embed id="basic_object"
       name="naclModule"
       width=0 height=0
       src="ppapi_basic_object.nexe"
       type="application/x-nacl" />
</body>

<embed id="user_main"
       name="naclModule"
       width=0 height=0
       src="ppapi_user_main.nexe"
       type="application/x-nacl" />
</body>

<script type="text/javascript">
//<![CDATA[
EnqueueTests($('basic_object'), '');

// Same interface but with a user-supplied main() entry point.
EnqueueTests($('user_main'), '_user');
//]]>
</script>
</html>
