<!DOCTYPE html>
<!--
Copyright (c) 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/range.html">
<link rel="import" href="/tracing/ui/base/d3.html">
<link rel="import" href="/tracing/ui/base/bar_chart.html">

<script>
'use strict';

tr.exportTo('tr.ui.b', function() {
  var BarChart = tr.ui.b.BarChart;

  var NAME_OFFSET = -0.3;

  // @constructor
  var NameBarChart = tr.ui.b.define('name-bar-chart', BarChart);

  NameBarChart.prototype = {
    __proto__: BarChart.prototype,

    decorate: function() {
      BarChart.prototype.decorate.call(this);
      this.classList.remove('bar-chart');
      this.classList.add('name-bar-chart');
      this.bottomMargin_ = 0;
    },

    isDatumFieldSeries_: function(fieldName) {
      return fieldName != 'x';
    },

    getXForDatum_: function(datum, index) {
      return index;
    },

    updateSeriesKeys_: function() {
      if (this.data_.length === 0)
        return;

      BarChart.prototype.updateSeriesKeys_.call(this);
      this.updateScales_();

      var chartAreaSel = d3.select(this.chartAreaElement);
      var nameTexts = chartAreaSel.select('.x.axis').selectAll('text')
        .data(this.data_);
      nameTexts
        .enter()
        .append('text')
        .attr('transform', function(d, index) {
            var cx = this.xScale_(index + NAME_OFFSET);
            return 'rotate(45 ' + cx + ' 0)';
          }.bind(this))
        .attr('x', 0)
        .attr('class', 'measure')
        .attr('y', 0)
        .text(function(d, index) {
            return d.x;
          }.bind(this));
      nameTexts.exit().remove();
      requestAnimationFrame(function() {
        nameTexts[0].forEach(function(t) {
          this.bottomMargin_ = Math.max(this.bottomMargin_, t.getBBox().width *
              Math.cos(Math.PI / 4));
        }, this);
        chartAreaSel.select('.x.axis').selectAll('text.measure').remove('*');
        this.updateContents_();
      }.bind(this));
    },

    getMargin_: function() {
      var margin = BarChart.prototype.getMargin_.call(this);
      margin.bottom += this.bottomMargin_;
      return margin;
    },

    updateXAxis_: function(xAxis) {
      xAxis.selectAll('*').remove();
      var y = this.chartAreaSize.height + 10;
      var nameTexts = xAxis.selectAll('text')
        .data(this.data_);
      nameTexts
        .enter()
        .append('text')
        .attr('transform', function(d, index) {
            var cx = this.xScale_(index + NAME_OFFSET);
            return 'rotate(45 ' + cx + ' ' + y + ')';
          }.bind(this))
        .attr('x', function(d, index) {
            return this.xScale_(index + NAME_OFFSET);
          }.bind(this))
        .attr('y', function(d) {
            return y;
          }.bind(this))
        .text(function(d, index) {
            return d.x;
          }.bind(this));
      nameTexts.exit().remove();
    }
  };

  return {
    NameBarChart: NameBarChart
  };
});
</script>
