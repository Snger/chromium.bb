<!DOCTYPE html>
<!--
Copyright 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/base/base.html">
<link rel="import" href="/tracing/base/event.html">
<link rel="import" href="/tracing/base/event_target.html">
<link rel="import" href="/tracing/base/units/time_display_mode.html">

<script>
'use strict';

tr.exportTo('tr.b.u', function() {
  var TimeDisplayModes = tr.b.u.TimeDisplayModes;

  function max(a, b) {
    if (a === undefined)
      return b;
    if (b === undefined)
      return a;
    return a.scale > b.scale ? a : b;
  }

  /** @constructor */
  function Unit() {
  }

  Unit.reset = function() {
    Unit.currentTimeDisplayMode = TimeDisplayModes.ms;
  };

  Unit.timestampFromUs = function(us) {
    return us / 1000;
  };

  Unit.maybeTimestampFromUs = function(us) {
    return us === undefined ? undefined : us / 1000;
  };

  Object.defineProperty(Unit, 'currentTimeDisplayMode', {
    get: function() {
      return Unit.currentTimeDisplayMode_;
    },
    // Use tr-ui-u-preferred-display-unit element instead of directly setting.
    set: function(value) {
      if (Unit.currentTimeDisplayMode_ === value)
        return;

      Unit.currentTimeDisplayMode_ = value;
      Unit.dispatchEvent(new tr.b.Event('display-mode-changed'));
    }
  });

  Unit.didPreferredTimeDisplayUnitChange = function() {
    var largest = undefined;
    var els = tr.b.findDeepElementsMatching(document.body,
        'tr-ui-u-preferred-display-unit');
    els.forEach(function(el) {
      largest = max(largest, el.preferredTimeDisplayMode);
    });

    Unit.currentDisplayUnit = largest === undefined ?
        TimeDisplayModes.ms : largest;
  };

  Unit.byName = {};
  Unit.byJSONName = {};

  Unit.fromJSON = function(object) {
    var u = Unit.byJSONName[object];
    if (u) {
      return u;
    }
    throw new Error('Unrecognized unit');
  };

  tr.b.EventTarget.decorate(Unit);
  Unit.reset();

  // Known display units follow.
  //////////////////////////////////////////////////////////////////////////////
  Unit.byName.timeDurationInMs = Unit.byJSONName['ms'] = {
    asJSON: function() { return 'ms'; },
    format: function(value) {
      return Unit.currentTimeDisplayMode_.format(value);
    }
  };

  Unit.byName.timeStampInMs = Unit.byJSONName['tsMs'] = {
    asJSON: function() { return 'tsMs'; },
    format: function(value) {
      return Unit.currentTimeDisplayMode_.format(value);
    }
  };

  Unit.byName.normalizedPercentage = Unit.byJSONName['n%'] = {
    asJSON: function() { return 'n%'; },
    format: function(value) {
      var tmp = new Number(Math.round(value * 100000) / 1000);
      return tmp.toLocaleString(undefined, {minimumFractionDigits: 3}) + '%';
    }
  };

  var SIZE_UNIT_PREFIXES = ['', 'Ki', 'Mi', 'Gi', 'Ti'];
  Unit.byName.sizeInBytes = Unit.byJSONName['sizeInBytes'] = {
    asJSON: function() { return 'sizeInBytes'; },
    format: function(value) {
      var signPrefix = '';
      if (value < 0) {
        signPrefix = '-';
        value = -value;
      }

      var i = 0;
      while (value >= 1024 && i < SIZE_UNIT_PREFIXES.length - 1) {
        value /= 1024;
        i++;
      }

      return signPrefix + value.toFixed(1) + ' ' + SIZE_UNIT_PREFIXES[i] + 'B';
    }
  };

  Unit.byName.energyInJoules = Unit.byJSONName['J'] = {
    asJSON: function() { return 'J'; },
    format: function(value) {
      return value
          .toLocaleString(undefined, { minimumFractionDigits: 3 }) + ' J';
    }
  };

  Unit.byName.powerInWatts = Unit.byJSONName['W'] = {
    asJSON: function() { return 'W'; },
    format: function(value) {
      return (value * 1000.0)
          .toLocaleString(undefined, { minimumFractionDigits: 3 }) + ' mW';
    }
  };

  Unit.byName.unitlessNumber = Unit.byJSONName['unitless'] = {
    asJSON: function() { return 'unitless'; },
    format: function(value) {
      return value.toLocaleString(
          undefined, {
            minimumFractionDigits: 3,
            maximumFractionDigits: 3});
    }
  };

  return {
    Unit: Unit
  };
});
</script>
