<!-- Used by media_fps_perf to calculate <video> performance statistics. -->

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>FPS Perf Test</title>
  </head>
  <body>
    <div id="log">
      Decoded frames: 0 Avg: 0<br>
      Dropped frames: 0 Avg: 0<br>
    </div>
    <video preload controls></video>
  </body>

  <script type="text/javascript">
    var video = document.querySelector("video");

    var decodedFrames = 0;
    var droppedFrames = 0;
    var decodedFPS = [];
    var droppedFPS = [];
    var startTime = 0;
    var intID = 0; // interval ID, used to end the window intervals.

    function calculateStats() {
      if (video.readyState <= HTMLMediaElement.HAVE_CURRENT_DATA ||
          video.paused || video.ended)
        return;

      currentTime = new Date().getTime();
      deltaTime = (currentTime - startTime) / 1000;
      startTime = currentTime;

      // Calculate decoded frames per sec.
      var fps = (video.webkitDecodedFrameCount - decodedFrames) / deltaTime;
      decodedFrames = video.webkitDecodedFrameCount;
      decodedFPS.push(fps);

      // Calculate dropped frames per sec.
      fps = (video.webkitDroppedFrameCount - droppedFrames) / deltaTime;
      droppedFrames = video.webkitDroppedFrameCount;
      droppedFPS.push(fps);

      var d = document.getElementById("log");
      d.innerHTML =
        "Decoded frames: " + decodedFrames +
        " Avg: " + decodedFPS + " fps.<br>" +
        "Dropped frames: " + droppedFrames +
        " Avg: " + droppedFPS + " fps.<br>";
    }

    video.addEventListener("playing", function(event) {
      decodedFrames = 0;
      droppedFrames = 0;
      decodedFPS = [];
      droppedFPS = [];
      startTime = new Date().getTime();
      intID = window.setInterval(calculateStats, 1000);
    });

    video.addEventListener("error", function() { endTest(false); }, false);
    video.addEventListener("ended", function() { endTest(true); }, false);

    function endTest(successFlag) {
      window.clearInterval(intID);
      // Notify PyAuto that we've completed the test run.
      if (window.domAutomationController)
        window.domAutomationController.send(successFlag);
    }

    function startTest(url) {
      // End any previously started tests.
      window.clearInterval(intID);

      video.src = url;
      video.play();
    }
  </script>
</html>
